<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispositivo B (Receptor)</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>
<body>
    <h1>Dispositivo B</h1>
    <button onclick="connect()">Conectar</button>

    <script>

        console.log('lolx')

        let urlParams = new URLSearchParams(window.location.search);
        let callId = urlParams.get("id");

        let apiKey = urlParams.get('apiKey')
        let projectId = urlParams.get('projectId')
        let messagingSenderId = urlParams.get('senderId') // warning, not same name
        let appId = urlParams.get('appId')

        // ðŸ”¥ ConfiguraciÃ³n de Firebase
        const firebaseConfig = {
            apiKey,
            authDomain: projectId + ".firebaseapp.com",
            databaseURL: "https://" + projectId + "-default-rtdb.firebaseio.com",
            projectId,
            storageBucket: projectId + ".appspot.com",
            messagingSenderId,
            appId
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let peerConnection;

        function connect() {
            if (!callId) {
                alert("No se encontrÃ³ el ID de la llamada.");
                return;
            }

            peerConnection = new RTCPeerConnection();

            // Escuchar oferta del Dispositivo A
            db.ref("calls/" + callId + "/offer").once("value", snapshot => {
                if (snapshot.exists()) {
                    let offer = snapshot.val();
                    peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

                    peerConnection.ondatachannel = (event) => {
                        let dataChannel = event.channel;
                        // dataChannel.onopen = () => console.log("ðŸ”— Canal de datos abierto");
                        dataChannel.onmessage = (event) => dataChannel.send(event.data.toString().toUpperCase());
                     };

                    // Crear respuesta (answer)
                    peerConnection.createAnswer().then(answer => {
                        peerConnection.setLocalDescription(answer);
                        db.ref("calls/" + callId + "/answer").set(answer);
                        // CONSOLE.LOG('connected!')
                    });
                }
            });
        }
    </script>
</body>
</html>
